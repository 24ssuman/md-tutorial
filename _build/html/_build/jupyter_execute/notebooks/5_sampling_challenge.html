
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Module 5: The Challenge of Sampling &#8212; Molecular Dynamics Tutorial for Beginners</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_build/jupyter_execute/notebooks/5_sampling_challenge';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Molecular Dynamics Tutorial for Beginners</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Molecular Dynamics Tutorial for Beginners
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_intro_to_MD.html">Module 1: Introduction to Molecular Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_physics_of_MD.html">Module 2: The Physics Behind MD</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_non_bonded_interactions.html">Module 3: Non-Bonded Interactions and Long-Range Electrostatics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/4_1D_simulations.html">Module 4: Simulating Simple 1D Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_sampling_challenge.html">Module 5: The Challenge of Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5.5_chossing_CVs.html">Lesson 5.2a: Choosing Good Collective Variables for Multi-Dimensional Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6_umbrella_sampling.html">Module 6: Enhanced Sampling I - Umbrella Sampling (US) &amp; PMF Reconstruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6.1_WHAM_detailed.html">WHAM, step by step (with plots)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/7_meta_dynamics.html">Module 7: Enhanced Sampling II - Metadynamics (MetaD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/8_ase_LJ_fluid_simulation.html">Module 8: Multi-Particle Simulations: Lennard-Jones Fluid with ASE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/9_ase_waterbox_simulation_not_working.html">Module 9: Simulating Molecular Systems: Water Box with ASE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/YOUR_USERNAME/YOUR_REPO/main?urlpath=lab/tree/./_build/jupyter_execute/notebooks/5_sampling_challenge.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/YOUR_USERNAME/YOUR_REPO" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/YOUR_USERNAME/YOUR_REPO/issues/new?title=Issue%20on%20page%20%2F_build/jupyter_execute/notebooks/5_sampling_challenge.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/_build/jupyter_execute/notebooks/5_sampling_challenge.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Module 5: The Challenge of Sampling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-imports-and-potential-functions-from-module-4">Setup: Imports and Potential Functions (from Module 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-1-timescales-and-rare-events">Lesson 5.1: Timescales and Rare Events</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-2-collective-variables-cvs">Lesson 5.2: Collective Variables (CVs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-3-introduction-to-free-energy">Lesson 5.3: Introduction to Free Energy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-pmf-for-the-simple-harmonic-oscillator">Example 1: PMF for the Simple Harmonic Oscillator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-pmf-for-the-double-well-potential">Example 2: PMF for the Double-Well Potential</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-the-sampling-problem-in-the-double-well">Discussion: The Sampling Problem in the Double Well</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="module-5-the-challenge-of-sampling">
<h1>Module 5: The Challenge of Sampling<a class="headerlink" href="#module-5-the-challenge-of-sampling" title="Link to this heading">#</a></h1>
<p>Welcome to Module 5! In Module 4, we successfully simulated simple 1D systems using both NVE (Velocity Verlet) and NVT (Langevin) dynamics. We saw how a particle behaves in a simple harmonic potential and, more importantly, in a double-well potential.</p>
<p>The double-well simulation highlighted a critical challenge in Molecular Dynamics: the <strong>sampling problem</strong>. This module delves into why sampling can be difficult, introduces the concept of Collective Variables to describe complex processes, and lays the groundwork for understanding Free Energy, which is often the target quantity we want to calculate.</p>
<section id="setup-imports-and-potential-functions-from-module-4">
<h2>Setup: Imports and Potential Functions (from Module 4)<a class="headerlink" href="#setup-imports-and-potential-functions-from-module-4" title="Link to this heading">#</a></h2>
<p>Let’s import the necessary libraries again and redefine our potential and force functions, plus the Langevin integrator from Module 4.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span> <span class="c1"># To handle potential log(0) issues</span>

<span class="c1"># Plotting style configuration (optional)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-darkgrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># Default figure size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Assume Boltzmann constant k_B = 1 for simplicity in reduced units</span>
<span class="n">k_B</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># --- Potential/Force Functions (from Module 3) ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">potential_sh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the potential energy of a simple harmonic oscillator.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">force_sh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the force on a particle in a simple harmonic potential.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span><span class="w"> </span><span class="nf">potential_dw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the potential energy of a double-well potential.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">force_dw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the force from a double-well potential.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># --- Langevin Integrator (from Module 4) ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">Velocity_verlet_langevin</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">target_temp</span><span class="p">,</span> <span class="n">force_func</span><span class="p">,</span> <span class="o">**</span><span class="n">force_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs one step of Langevin dynamics using the BAOAB integrator.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_curr (float): Current position.</span>
<span class="sd">        v_curr (float): Current velocity.</span>
<span class="sd">        mass (float): Mass of the particle.</span>
<span class="sd">        dt (float): Time step.</span>
<span class="sd">        gamma (float): Friction coefficient.</span>
<span class="sd">        target_temp (float): Target temperature (kB=1).</span>
<span class="sd">        force_func (callable): Function to calculate the physical force.</span>
<span class="sd">        **force_args: Additional keyword arguments for the force function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (x_new, v_new) - Updated position and velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Update velocity by half step with current force</span>
    <span class="n">f_curr</span> <span class="o">=</span> <span class="n">force_func</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="o">**</span><span class="n">force_args</span><span class="p">)</span>
    <span class="n">v_half_b</span> <span class="o">=</span> <span class="n">v_curr</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_curr</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Update position by half step</span>
    <span class="n">x_half_a</span> <span class="o">=</span> <span class="n">x_curr</span> <span class="o">+</span> <span class="n">v_half_b</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Apply friction and random kick</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
    <span class="c1"># Ensure target_temp is non-negative before sqrt</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_B</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_temp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">c1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span>
    <span class="c1"># Generate random number from standard normal distribution</span>
    <span class="n">random_kick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">v_half_o</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">v_half_b</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">random_kick</span>

    <span class="c1"># Update position by second half step</span>
    <span class="n">x_new</span> <span class="o">=</span> <span class="n">x_half_a</span> <span class="o">+</span> <span class="n">v_half_o</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Update velocity by half step with force at *new* position</span>
    <span class="n">f_new</span> <span class="o">=</span> <span class="n">force_func</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="o">**</span><span class="n">force_args</span><span class="p">)</span>
    <span class="n">v_new</span> <span class="o">=</span> <span class="n">v_half_o</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_new</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_new</span><span class="p">,</span> <span class="n">v_new</span>


<span class="c1"># --- Parameters from Module 4 ---</span>
<span class="c1"># SHO</span>
<span class="n">k_sh</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1"># Double Well</span>
<span class="n">a_dw</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">b_dw</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="n">minima_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b_dw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_dw</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum Position for DW: </span><span class="si">{</span><span class="n">minima_pos</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">minima_val</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="n">minima_pos</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">barrier_top_val</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">barrier_height</span> <span class="o">=</span> <span class="n">barrier_top_val</span> <span class="o">-</span> <span class="n">minima_val</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setup complete. Functions and parameters loaded.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Double-well barrier height: </span><span class="si">{</span><span class="n">barrier_height</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimum Position for DW: 1.41
Setup complete. Functions and parameters loaded.
Double-well barrier height: 4.00
</pre></div>
</div>
</div>
</div>
</section>
<section id="lesson-5-1-timescales-and-rare-events">
<h2>Lesson 5.1: Timescales and Rare Events<a class="headerlink" href="#lesson-5-1-timescales-and-rare-events" title="Link to this heading">#</a></h2>
<p>Recall our NVE simulation of the particle in the double-well potential (Lesson 3.3). Depending on the initial energy we gave the particle:</p>
<ul class="simple">
<li><p><strong>If the total energy was less than the barrier height:</strong> The particle remained trapped in its initial well for the entire simulation. It couldn’t sample the other stable state.</p></li>
<li><p><strong>If the total energy was just slightly above the barrier height:</strong> The particle might have crossed the barrier, but perhaps only a few times during the simulation run.</p></li>
<li><p><strong>If the total energy was much higher than the barrier:</strong> The particle crossed back and forth frequently.</p></li>
</ul>
<p>This illustrates a fundamental limitation of standard MD simulations. Many interesting biological or chemical processes involve transitions between <strong>metastable states</strong> separated by significant <strong>energy barriers</strong>. Examples include:</p>
<ul class="simple">
<li><p>Protein folding/unfolding</p></li>
<li><p>Ligand binding/unbinding</p></li>
<li><p>Conformational changes in molecules</p></li>
<li><p>Chemical reactions</p></li>
<li><p>Phase transitions</p></li>
</ul>
<p>These transitions might occur on timescales of microseconds (<span class="math notranslate nohighlight">\(\mu\)</span>s), milliseconds (ms), or even longer in reality. However, due to the tiny time step required (<span class="math notranslate nohighlight">\(\sim\)</span>femtoseconds, fs), even a very long MD simulation (millions or billions of steps) might only cover nanoseconds (ns) or microseconds (<span class="math notranslate nohighlight">\(\mu\)</span>s) of real time.</p>
<p>If the timescale of the process we’re interested in is much longer than the simulation time achievable, the transition event becomes a <strong>“rare event”</strong> in the context of our simulation. We simply won’t observe enough transitions (or maybe any at all) to get meaningful statistics or understand the process kinetics or thermodynamics.</p>
<p><strong>The Sampling Problem:</strong> Standard MD tends to get trapped in local energy minima (like the wells in our double-well potential) and fails to adequately explore the entire relevant configuration space, especially regions separated by high energy barriers, within feasible simulation times.</p>
</section>
<section id="lesson-5-2-collective-variables-cvs">
<h2>Lesson 5.2: Collective Variables (CVs)<a class="headerlink" href="#lesson-5-2-collective-variables-cvs" title="Link to this heading">#</a></h2>
<p>To study complex processes like barrier crossing, folding, or binding, it’s often helpful to describe the progress of the process using one or a few key parameters, rather than tracking the coordinates of all atoms (<span class="math notranslate nohighlight">\(3N\)</span> coordinates!). These key parameters are called <strong>Collective Variables (CVs)</strong>, <strong>order parameters</strong>, or <strong>reaction coordinates</strong>.</p>
<p>A good CV should:</p>
<ul class="simple">
<li><p>Distinguish between the initial state, final state, and any intermediate/transition states.</p></li>
<li><p>Capture the essential motion or change occurring during the process.</p></li>
</ul>
<p><strong>Examples of CVs:</strong></p>
<ul class="simple">
<li><p><strong>Distance:</strong> Between two specific atoms or centers of mass of molecular groups (e.g., distance between a drug and its binding site).</p></li>
<li><p><strong>Angle:</strong> Formed by three atoms (e.g., bending angle in a molecule).</p></li>
<li><p><strong>Dihedral Angle:</strong> Rotation around a bond (e.g., backbone <span class="math notranslate nohighlight">\(\phi/\psi\)</span> angles in proteins, crucial for conformation).</p></li>
<li><p><strong>Radius of Gyration:</strong> A measure of the overall compactness of a molecule (e.g., for protein folding).</p></li>
<li><p><strong>Coordination Number:</strong> The number of neighboring atoms/molecules within a certain distance (e.g., number of water molecules around an ion).</p></li>
</ul>
<p><strong>CVs in our 1D System:</strong>
For our simple 1D double-well system, the choice of CV is straightforward: the <strong>position <span class="math notranslate nohighlight">\(x\)</span> itself</strong> is the natural collective variable. It clearly distinguishes the left well (<span class="math notranslate nohighlight">\(x \approx -\sqrt{b/2a}\)</span>), the right well (<span class="math notranslate nohighlight">\(x \approx +\sqrt{b/2a}\)</span>), and the transition region near the barrier top (<span class="math notranslate nohighlight">\(x \approx 0\)</span>).</p>
<p>The goal of many simulation studies, especially those involving enhanced sampling, is to understand how the system behaves as a function of one or more chosen CVs. We often want to calculate the <em>free energy</em> profile along a CV.</p>
</section>
<section id="lesson-5-3-introduction-to-free-energy">
<h2>Lesson 5.3: Introduction to Free Energy<a class="headerlink" href="#lesson-5-3-introduction-to-free-energy" title="Link to this heading">#</a></h2>
<p>Why are we interested in calculating properties along a CV? Often, the goal is to determine the <strong>Free Energy</strong> profile along that coordinate.</p>
<p><strong>Conceptual Overview:</strong>
You might recall Gibbs Free Energy (<span class="math notranslate nohighlight">\(G\)</span>) or Helmholtz Free Energy (<span class="math notranslate nohighlight">\(A\)</span> or <span class="math notranslate nohighlight">\(F\)</span>) from thermodynamics. Free energy represents the amount of energy available to do useful work and determines the spontaneity of processes at constant temperature and pressure (Gibbs) or constant temperature and volume (Helmholtz). Systems tend to evolve towards states of lower free energy.</p>
<ul class="simple">
<li><p><strong>Low free energy regions</strong> correspond to <strong>stable or metastable states</strong> (like the bottoms of the wells in our double-well potential). These states have high probability of being occupied.</p></li>
<li><p><strong>High free energy regions</strong> correspond to <strong>unstable states or transition barriers</strong>. These states have low probability of being occupied.</p></li>
</ul>
<p><strong>Free Energy and Probability:</strong>
Statistical mechanics provides a fundamental link between the free energy <span class="math notranslate nohighlight">\(F\)</span> of a system as a function of a collective variable <span class="math notranslate nohighlight">\(q\)</span> and the probability <span class="math notranslate nohighlight">\(P(q)\)</span> of observing the system with that value of the CV:</p>
<div class="math notranslate nohighlight">
\[ F(q) = -k_B T \ln P(q) + C \]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(k_B\)</span> is the Boltzmann constant.</p></li>
<li><p><span class="math notranslate nohighlight">\(T\)</span> is the absolute temperature.</p></li>
<li><p><span class="math notranslate nohighlight">\(P(q)\)</span> is the probability density of finding the system at a specific value <span class="math notranslate nohighlight">\(q\)</span> of the collective variable.</p></li>
<li><p><span class="math notranslate nohighlight">\(C\)</span> is an arbitrary constant (since absolute free energy is often not needed, only differences).</p></li>
</ul>
<p>This equation is crucial! It tells us that if we could somehow determine the probability distribution <span class="math notranslate nohighlight">\(P(q)\)</span> along our chosen CV, we could directly calculate the free energy profile <span class="math notranslate nohighlight">\(F(q)\)</span>.</p>
<p><strong>Potential of Mean Force (PMF):</strong>
The free energy profile along a collective variable, <span class="math notranslate nohighlight">\(F(q)\)</span>, is often called the <strong>Potential of Mean Force (PMF)</strong>. It represents the effective potential energy experienced by the system as it moves along the coordinate <span class="math notranslate nohighlight">\(q\)</span>, averaged over all other degrees of freedom. The negative gradient of the PMF gives the average force acting along the CV.</p>
<p><strong>Calculating PMF from Simulation Data:</strong>
If we run a long enough simulation in the NVT ensemble (where temperature T is constant), we can approximate <span class="math notranslate nohighlight">\(P(q)\)</span> by creating a histogram of the observed values of our CV <span class="math notranslate nohighlight">\(q\)</span>.</p>
<ol class="arabic simple">
<li><p>Run an NVT simulation (e.g., using Langevin dynamics).</p></li>
<li><p>Record the values of the CV (in our 1D case, the position <span class="math notranslate nohighlight">\(x\)</span>) at regular intervals.</p></li>
<li><p>Create a histogram of these recorded CV values.</p></li>
<li><p>Normalize the histogram counts to get an estimate of the probability density <span class="math notranslate nohighlight">\(P(q)\)</span>.</p></li>
<li><p>Calculate the PMF using <span class="math notranslate nohighlight">\(F(q) = -k_B T \ln P(q)\)</span>.</p></li>
</ol>
<p>Let’s try this for our 1D systems.</p>
<section id="example-1-pmf-for-the-simple-harmonic-oscillator">
<h3>Example 1: PMF for the Simple Harmonic Oscillator<a class="headerlink" href="#example-1-pmf-for-the-simple-harmonic-oscillator" title="Link to this heading">#</a></h3>
<p>First, let’s run an NVT simulation for the SHO using the Langevin integrator from Module 3. We need a reasonably long simulation to get good statistics for the histogram.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NVT Langevin Simulation Parameters for SHO PMF</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>          <span class="c1"># Friction coefficient</span>
<span class="n">target_temp_sho</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Target temperature (kB=1)</span>
<span class="n">n_steps_sho_pmf</span> <span class="o">=</span> <span class="mi">100000</span> <span class="c1"># Longer simulation for better sampling</span>
<span class="n">record_stride</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c1"># Record position every &#39;record_stride&#39; steps</span>

<span class="c1"># Arrays to store NVT results (only need positions for PMF)</span>
<span class="n">n_recorded_steps</span> <span class="o">=</span> <span class="n">n_steps_sho_pmf</span> <span class="o">//</span> <span class="n">record_stride</span>
<span class="n">positions_nvt_sho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_recorded_steps</span><span class="p">)</span>

<span class="c1"># Initial conditions</span>
<span class="n">x_curr</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Start at bottom</span>
<span class="n">v_curr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_temp_sho</span> <span class="o">*</span> <span class="n">k_B</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="c1"># Start with typical velocity</span>

<span class="c1"># --- NVT Langevin Simulation Loop (SHO) ---</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting NVT (Langevin) SHO simulation for PMF (</span><span class="si">{</span><span class="n">n_steps_sho_pmf</span><span class="si">}</span><span class="s2"> steps)...&quot;</span><span class="p">)</span>
<span class="n">record_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps_sho_pmf</span><span class="p">):</span>
    <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span> <span class="o">=</span> <span class="n">Velocity_verlet_langevin</span><span class="p">(</span>
        <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">target_temp_sho</span><span class="p">,</span>
        <span class="n">force_sh</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_sh</span>
    <span class="p">)</span>
    <span class="c1"># Record position at specified stride</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">record_stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">record_index</span> <span class="o">&lt;</span> <span class="n">n_recorded_steps</span><span class="p">:</span>
            <span class="n">positions_nvt_sho</span><span class="p">[</span><span class="n">record_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_curr</span>
            <span class="n">record_index</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NVT (Langevin) SHO Simulation finished. Recorded </span><span class="si">{</span><span class="n">record_index</span><span class="si">}</span><span class="s2"> positions.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting NVT (Langevin) SHO simulation for PMF (100000 steps)...
NVT (Langevin) SHO Simulation finished. Recorded 10000 positions.
</pre></div>
</div>
</div>
</div>
<p>Now, let’s calculate the histogram of the recorded positions and compute the PMF.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Histogram</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># Number of bins for the histogram</span>
<span class="n">hist_sho</span><span class="p">,</span> <span class="n">bin_edges_sho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">positions_nvt_sho</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># &#39;density=True&#39; normalizes histogram so the area integrates to 1 (approximates PDF)</span>

<span class="c1"># Get bin centers</span>
<span class="n">bin_centers_sho</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges_sho</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bin_edges_sho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Calculate PMF: F(x) = -kB * T * ln(P(x))</span>
<span class="c1"># Avoid log(0) for empty bins by adding a small epsilon or filtering</span>
<span class="n">pmf_sho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">hist_sho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="c1"># Initialize with infinity</span>
<span class="n">non_zero_mask</span> <span class="o">=</span> <span class="n">hist_sho</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="c1"># Mask for bins with non-negligible probability</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span> <span class="c1"># Suppress log(0) warnings safely</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">pmf_sho</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">target_temp_sho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist_sho</span><span class="p">[</span><span class="n">non_zero_mask</span><span class="p">])</span>

<span class="c1"># Shift PMF so its minimum is at zero for easier comparison</span>
<span class="n">pmf_sho</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pmf_sho</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pmf_sho</span><span class="p">)])</span> <span class="c1"># Subtract minimum finite value</span>

<span class="c1"># Calculate analytical potential for comparison</span>
<span class="n">analytical_potential_sho</span> <span class="o">=</span> <span class="n">potential_sh</span><span class="p">(</span><span class="n">bin_centers_sho</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k_sh</span><span class="p">)</span>
<span class="n">analytical_potential_sho</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">analytical_potential_sho</span><span class="p">)</span> <span class="c1"># Shift minimum to zero</span>

<span class="c1"># --- Plot Histogram and PMF (SHO) ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot Histogram</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">positions_nvt_sho</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position Histogram&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density P(x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SHO Position Distribution (NVT)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot PMF vs Analytical Potential</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_sho</span><span class="p">,</span> <span class="n">pmf_sho</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PMF from Simulation&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_sho</span><span class="p">,</span> <span class="n">analytical_potential_sho</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Potential V(x)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Free Energy / Potential (shifted)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SHO: Calculated PMF vs Analytical Potential&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">barrier_height</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">barrier_height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Adjust ylim based on expected energy range</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHO PMF calculation and plotting complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/e731178b5a7f2549a06b9205f5fd23c1e51c870aaea39cf4ab792faaf9352227.png" src="../../../_images/e731178b5a7f2549a06b9205f5fd23c1e51c870aaea39cf4ab792faaf9352227.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SHO PMF calculation and plotting complete.
</pre></div>
</div>
</div>
</div>
<p>For the Simple Harmonic Oscillator, if the simulation is long enough, the calculated PMF should match the analytical potential energy curve <span class="math notranslate nohighlight">\(V(x) = \frac{1}{2}kx^2\)</span> very well (after shifting the minimum to zero). This confirms that the simulation correctly samples the Boltzmann distribution <span class="math notranslate nohighlight">\(P(x) \propto e^{-V(x)/k_B T}\)</span> for this simple potential.</p>
</section>
<section id="example-2-pmf-for-the-double-well-potential">
<h3>Example 2: PMF for the Double-Well Potential<a class="headerlink" href="#example-2-pmf-for-the-double-well-potential" title="Link to this heading">#</a></h3>
<p>Now, let’s repeat the process for the double-well potential. Here, we expect to see the sampling problem more clearly, especially if the temperature is not significantly higher than the barrier height. We’ll use a temperature comparable to the barrier height.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NVT Langevin Simulation Parameters for DW PMF</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>          <span class="c1"># Friction coefficient</span>
<span class="c1"># Choose temperature carefully: Try T ~ barrier height first</span>
<span class="n">target_temp_dw</span> <span class="o">=</span> <span class="n">barrier_height</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="c1"># e.g., 80% of barrier height (kB=1)</span>
<span class="n">n_steps_dw_pmf</span> <span class="o">=</span> <span class="mi">200000</span> <span class="c1"># Longer simulation needed for DW</span>
<span class="n">record_stride</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c1"># Record position every &#39;record_stride&#39; steps</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target Temperature for DW: </span><span class="si">{</span><span class="n">target_temp_dw</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (Barrier Height: </span><span class="si">{</span><span class="n">barrier_height</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Arrays to store NVT results</span>
<span class="n">n_recorded_steps_dw</span> <span class="o">=</span> <span class="n">n_steps_dw_pmf</span> <span class="o">//</span> <span class="n">record_stride</span>
<span class="n">positions_nvt_dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_recorded_steps_dw</span><span class="p">)</span>

<span class="c1"># Initial conditions (start in one well)</span>
<span class="n">x_curr</span> <span class="o">=</span> <span class="o">-</span><span class="n">minima_pos</span> <span class="c1"># Start at the left minimum</span>
<span class="n">v_curr</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># Start at rest</span>

<span class="c1"># --- NVT Langevin Simulation Loop (DW) ---</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting NVT (Langevin) DW simulation for PMF (</span><span class="si">{</span><span class="n">n_steps_dw_pmf</span><span class="si">}</span><span class="s2"> steps)...&quot;</span><span class="p">)</span>
<span class="n">record_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps_dw_pmf</span><span class="p">):</span>
    <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span> <span class="o">=</span> <span class="n">Velocity_verlet_langevin</span><span class="p">(</span>
        <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">target_temp_dw</span><span class="p">,</span>
        <span class="n">force_dw</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span>
    <span class="p">)</span>
    <span class="c1"># Record position at specified stride</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">record_stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">record_index</span> <span class="o">&lt;</span> <span class="n">n_recorded_steps_dw</span><span class="p">:</span>
            <span class="n">positions_nvt_dw</span><span class="p">[</span><span class="n">record_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_curr</span>
            <span class="n">record_index</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NVT (Langevin) DW Simulation finished. Recorded </span><span class="si">{</span><span class="n">record_index</span><span class="si">}</span><span class="s2"> positions.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target Temperature for DW: 0.40 (Barrier Height: 4.00)
Starting NVT (Langevin) DW simulation for PMF (200000 steps)...
NVT (Langevin) DW Simulation finished. Recorded 20000 positions.
</pre></div>
</div>
</div>
</div>
<p>Calculate the histogram and PMF for the double-well simulation. Pay attention to the barrier region (<span class="math notranslate nohighlight">\(x \approx 0\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Histogram</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># Number of bins for the histogram</span>
<span class="n">hist_dw</span><span class="p">,</span> <span class="n">bin_edges_dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">positions_nvt_dw</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Ensure range covers both wells</span>

<span class="c1"># Get bin centers</span>
<span class="n">bin_centers_dw</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_edges_dw</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bin_edges_dw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Calculate PMF: F(x) = -kB * T * ln(P(x))</span>
<span class="n">pmf_dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">hist_dw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="c1"># Initialize with infinity</span>
<span class="n">non_zero_mask_dw</span> <span class="o">=</span> <span class="n">hist_dw</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="c1"># Mask for bins with non-negligible probability</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span> <span class="c1"># Suppress log(0) warnings safely</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">pmf_dw</span><span class="p">[</span><span class="n">non_zero_mask_dw</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">target_temp_dw</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist_dw</span><span class="p">[</span><span class="n">non_zero_mask_dw</span><span class="p">])</span>

<span class="c1"># Shift PMF so its minimum is at zero</span>
<span class="n">min_pmf_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pmf_dw</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pmf_dw</span><span class="p">)])</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">min_pmf_val</span><span class="p">):</span>
    <span class="n">pmf_dw</span> <span class="o">-=</span> <span class="n">min_pmf_val</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not find finite minimum PMF value. PMF might be empty.&quot;</span><span class="p">)</span>


<span class="c1"># Calculate analytical potential for comparison</span>
<span class="n">analytical_potential_dw</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="n">bin_centers_dw</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">analytical_potential_dw</span> <span class="o">-=</span> <span class="n">minima_val</span> <span class="c1"># Shift minimum to zero</span>

<span class="c1"># --- Plot Histogram and PMF (DW) ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot Histogram</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">positions_nvt_dw</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position Histogram&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density P(x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DW Position Distribution (NVT, T=</span><span class="si">{</span><span class="n">target_temp_dw</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot PMF vs Analytical Potential</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_dw</span><span class="p">,</span> <span class="n">pmf_dw</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PMF from Simulation&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centers_dw</span><span class="p">,</span> <span class="n">analytical_potential_dw</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Potential V(x)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Free Energy / Potential (shifted)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DW: Calculated PMF vs Analytical Potential (T=</span><span class="si">{</span><span class="n">target_temp_dw</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">barrier_height</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">barrier_height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Adjust ylim</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DW PMF calculation and plotting complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/dfcdaacab755026e09ce972b083583f7b22e253622522096a58a75c053ee8057.png" src="../../../_images/dfcdaacab755026e09ce972b083583f7b22e253622522096a58a75c053ee8057.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DW PMF calculation and plotting complete.
</pre></div>
</div>
</div>
</div>
</section>
<section id="discussion-the-sampling-problem-in-the-double-well">
<h3>Discussion: The Sampling Problem in the Double Well<a class="headerlink" href="#discussion-the-sampling-problem-in-the-double-well" title="Link to this heading">#</a></h3>
<p>Look closely at the histogram and the calculated PMF for the double-well potential.</p>
<ul class="simple">
<li><p><strong>Histogram:</strong> Did the simulation spend significant time near the barrier top (<span class="math notranslate nohighlight">\(x \approx 0\)</span>)? Or did it mostly stay within one or both wells? The probability density <span class="math notranslate nohighlight">\(P(x)\)</span> will be very low in regions the simulation didn’t visit often.</p></li>
<li><p><strong>PMF:</strong> Because <span class="math notranslate nohighlight">\(F(x) \propto -\ln P(x)\)</span>, regions with very low probability <span class="math notranslate nohighlight">\(P(x)\)</span> will correspond to very high (or infinite, if <span class="math notranslate nohighlight">\(P(x)=0\)</span>) free energy in our calculated PMF.</p>
<ul>
<li><p>You might see large gaps or infinite values in the PMF around the barrier region.</p></li>
<li><p>If the temperature was too low or the simulation too short, the PMF might only show one of the wells, completely missing the other side of the potential.</p></li>
</ul>
</li>
</ul>
<p><strong>This is the sampling problem in action!</strong> The standard NVT simulation, even with the correct Langevin thermostat, struggles to gather enough statistics in the high-energy barrier region. The calculated PMF is therefore unreliable or incomplete in these crucial areas.</p>
<p><strong>Why we need Enhanced Sampling:</strong> To get an accurate PMF across the entire range, including the transition barrier, we need methods that <em>force</em> the simulation to spend more time in these high-energy regions than it normally would. This is precisely what techniques like Umbrella Sampling (Module 5) and Metadynamics (Module 6) are designed to do. They introduce biases that counteract the energy barriers, allowing for better sampling and a more complete reconstruction of the free energy landscape.</p>
<hr class="docutils" />
<p>End of Module 5. We’ve explored the theoretical challenges behind MD simulations and seen a practical demonstration:</p>
<ul class="simple">
<li><p><strong>Timescales and Rare Events:</strong> Standard MD struggles to simulate processes that are slow due to high energy barriers.</p></li>
<li><p><strong>Collective Variables (CVs):</strong> We can simplify complex processes by describing them with one or a few key parameters (like position ‘x’ in our 1D case).</p></li>
<li><p><strong>Free Energy (PMF):</strong> This thermodynamic quantity is linked to the probability of observing a state (<span class="math notranslate nohighlight">\(F(q) \propto -\ln P(q)\)</span>) and is often the target of our calculations.</p></li>
<li><p><strong>Sampling Problem Demonstration:</strong> By calculating the PMF from standard NVT simulations, we observed that while it works well for simple potentials (SHO), it fails to capture the full landscape for potentials with significant barriers (Double Well), highlighting the poor sampling of high-energy regions.</p></li>
</ul>
<p>With this understanding and practical illustration of the sampling problem, we are now ready to learn techniques designed to tackle it. In Module 6, we will implement our first enhanced sampling method: <strong>Umbrella Sampling</strong>.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "YOUR_USERNAME/YOUR_REPO",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_build/jupyter_execute/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-imports-and-potential-functions-from-module-4">Setup: Imports and Potential Functions (from Module 4)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-1-timescales-and-rare-events">Lesson 5.1: Timescales and Rare Events</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-2-collective-variables-cvs">Lesson 5.2: Collective Variables (CVs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-5-3-introduction-to-free-energy">Lesson 5.3: Introduction to Free Energy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-pmf-for-the-simple-harmonic-oscillator">Example 1: PMF for the Simple Harmonic Oscillator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-pmf-for-the-double-well-potential">Example 2: PMF for the Double-Well Potential</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion-the-sampling-problem-in-the-double-well">Discussion: The Sampling Problem in the Double Well</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Your Name
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>