
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Module 7: Enhanced Sampling II - Metadynamics (MetaD) &#8212; Molecular Dynamics Tutorial for Beginners</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_build/jupyter_execute/notebooks/7_meta_dynamics';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Molecular Dynamics Tutorial for Beginners</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Molecular Dynamics Tutorial for Beginners
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_intro_to_MD.html">Module 1: Introduction to Molecular Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_physics_of_MD.html">Module 2: The Physics Behind MD</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_non_bonded_interactions.html">Module 3: Non-Bonded Interactions and Long-Range Electrostatics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/4_1D_simulations.html">Module 4: Simulating Simple 1D Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_sampling_challenge.html">Module 5: The Challenge of Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5.5_chossing_CVs.html">Lesson 5.2a: Choosing Good Collective Variables for Multi-Dimensional Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6_umbrella_sampling.html">Module 6: Enhanced Sampling I - Umbrella Sampling (US) &amp; PMF Reconstruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/6.1_WHAM_detailed.html">WHAM, step by step (with plots)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/7_meta_dynamics.html">Module 7: Enhanced Sampling II - Metadynamics (MetaD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/8_ase_LJ_fluid_simulation.html">Module 8: Multi-Particle Simulations: Lennard-Jones Fluid with ASE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/9_ase_waterbox_simulation_not_working.html">Module 9: Simulating Molecular Systems: Water Box with ASE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/YOUR_USERNAME/YOUR_REPO/main?urlpath=lab/tree/./_build/jupyter_execute/notebooks/7_meta_dynamics.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/YOUR_USERNAME/YOUR_REPO" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/YOUR_USERNAME/YOUR_REPO/issues/new?title=Issue%20on%20page%20%2F_build/jupyter_execute/notebooks/7_meta_dynamics.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/_build/jupyter_execute/notebooks/7_meta_dynamics.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Module 7: Enhanced Sampling II - Metadynamics (MetaD)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-imports-and-functions-from-modules-4-5">Setup: Imports and Functions (from Modules 4 &amp; 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-1-the-concept-of-filling-the-free-energy-landscape">Lesson 7.1: The Concept of Filling the Free Energy Landscape</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-2-the-metadynamics-bias">Lesson 7.2: The Metadynamics Bias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-3-implementing-metadynamics">Lesson 7.3: Implementing Metadynamics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-metadynamics-bias-functions">Defining Metadynamics Bias Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-integrator-for-metadynamics-bias">Modifying the Integrator for Metadynamics Bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-metadynamics-parameters">Setting Metadynamics Parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-hill-width-from-unbiased-sampling">7.2.1 Estimating Hill Width (σ) from Unbiased Sampling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-hill-width-and-height">7.2.2 Setting Hill Width and Height</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-exercise-running-the-metadynamics-simulation">Coding Exercise: Running the Metadynamics Simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-4-reconstructing-the-free-energy">Lesson 7.4: Reconstructing the Free Energy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-calculating-and-plotting-the-reconstructed-pmf">Exercise: Calculating and Plotting the Reconstructed PMF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-of-pmf-vs-number-of-hills">7.4.2 Convergence of PMF vs. Number of Hills</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-5-comparing-us-and-metad">Lesson 7.5: Comparing US and MetaD</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="module-7-enhanced-sampling-ii-metadynamics-metad">
<h1>Module 7: Enhanced Sampling II - Metadynamics (MetaD)<a class="headerlink" href="#module-7-enhanced-sampling-ii-metadynamics-metad" title="Link to this heading">#</a></h1>
<p>Welcome to Module 7! Following our exploration of Umbrella Sampling in Module 6, we now turn to another powerful enhanced sampling technique: <strong>Metadynamics (MetaD)</strong>.</p>
<p>Unlike Umbrella Sampling, which uses static bias potentials in separate windows, Metadynamics employs a <strong>history-dependent bias potential</strong> that adaptively discourages the system from revisiting previously explored regions of the collective variable (CV) space. This allows the system to overcome energy barriers and explore the free energy landscape more efficiently. We will implement Metadynamics for our 1D double-well potential and reconstruct the PMF from the accumulated bias.</p>
<section id="setup-imports-and-functions-from-modules-4-5">
<h2>Setup: Imports and Functions (from Modules 4 &amp; 5)<a class="headerlink" href="#setup-imports-and-functions-from-modules-4-5" title="Link to this heading">#</a></h2>
<p>Let’s import libraries and redefine the necessary functions (potential, force, Langevin integrator structure).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span> <span class="c1"># To handle potential log(0) issues</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span> <span class="c1"># To track simulation time</span>

<span class="c1"># Plotting style configuration (optional)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-darkgrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># Default figure size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Assume Boltzmann constant k_B = 1 for simplicity in reduced units</span>
<span class="n">k_B</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1"># Define temperature here as it&#39;s needed globally</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Will be set properly later</span>

<span class="c1"># --- Potential/Force Functions ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">potential_dw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the potential energy of a double-well potential.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">force_dw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the force from a double-well potential.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># --- Parameters for Double Well ---</span>
<span class="n">a_dw</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">b_dw</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="n">minima_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b_dw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a_dw</span><span class="p">))</span>
<span class="n">minima_val</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="n">minima_pos</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">barrier_top_val</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">barrier_height</span> <span class="o">=</span> <span class="n">barrier_top_val</span> <span class="o">-</span> <span class="n">minima_val</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setup complete. Functions and parameters loaded.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Double-well barrier height: </span><span class="si">{</span><span class="n">barrier_height</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Beginner-friendly runtime switch</span>
<span class="n">FAST_MODE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAST_MODE = </span><span class="si">{</span><span class="n">FAST_MODE</span><span class="si">}</span><span class="s2"> (set to False for a longer, more converged MetaD run)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Setup complete. Functions and parameters loaded.
Double-well barrier height: 4.00
</pre></div>
</div>
</div>
</div>
</section>
<section id="lesson-7-1-the-concept-of-filling-the-free-energy-landscape">
<h2>Lesson 7.1: The Concept of Filling the Free Energy Landscape<a class="headerlink" href="#lesson-7-1-the-concept-of-filling-the-free-energy-landscape" title="Link to this heading">#</a></h2>
<p>Metadynamics works by gradually “filling up” the free energy wells along the chosen collective variable(s) <span class="math notranslate nohighlight">\(q\)</span> (here, <span class="math notranslate nohighlight">\(q=x\)</span>). Imagine pouring sand into the potential wells – eventually, the sand fills the wells, making it easier for the particle to escape and explore other regions, including crossing barriers.</p>
<p>Computationally, this is achieved by adding small repulsive potentials (typically Gaussian functions, or “hills”) centered at the system’s current position in the CV space at regular time intervals. As the simulation progresses:</p>
<ol class="arabic simple">
<li><p>The system explores a region (e.g., a potential well).</p></li>
<li><p>Gaussian hills are deposited in this region, raising its effective energy.</p></li>
<li><p>The system is discouraged from revisiting this region and is pushed to explore new areas.</p></li>
<li><p>Eventually, enough hills are added to overcome major energy barriers.</p></li>
</ol>
<p>The sum of all deposited Gaussian hills forms the history-dependent bias potential, <span class="math notranslate nohighlight">\(V_{bias}(x, t)\)</span>.</p>
</section>
<section id="lesson-7-2-the-metadynamics-bias">
<h2>Lesson 7.2: The Metadynamics Bias<a class="headerlink" href="#lesson-7-2-the-metadynamics-bias" title="Link to this heading">#</a></h2>
<p>The bias potential in Metadynamics at time <span class="math notranslate nohighlight">\(t\)</span> is the sum of all Gaussian hills deposited up to that time:
$<span class="math notranslate nohighlight">\( V_{bias}(x, t) = \sum_{t' \in \{ 	au, 2	au, 3	au, ... \}, t' &lt; t} W \exp\left(-\frac{(x - x(t'))^2}{2\sigma^2}\right) \)</span>$
where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x(t')\)</span> is the position (our CV) of the particle at the time <span class="math notranslate nohighlight">\(t'\)</span> when a hill was deposited.</p></li>
<li><p><span class="math notranslate nohighlight">\(W\)</span> is the <strong>height</strong> of the Gaussian hills (energy units).</p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma\)</span> (sigma) is the <strong>width</strong> of the Gaussian hills (units of the CV, i.e., length).</p></li>
<li><p><span class="math notranslate nohighlight">\(	au\)</span> (tau) is the <strong>deposition stride</strong> – the time interval (or number of simulation steps) between adding new hills.</p></li>
</ul>
<p><strong>Key Parameters:</strong>
The choice of <span class="math notranslate nohighlight">\(W\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span>, and <span class="math notranslate nohighlight">\(	au\)</span> is crucial for the efficiency and accuracy of Metadynamics:</p>
<ul class="simple">
<li><p><strong>Hill Height (<span class="math notranslate nohighlight">\(W\)</span>):</strong> Should be small compared to the barrier height and <span class="math notranslate nohighlight">\(k_B T\)</span>. Too large <span class="math notranslate nohighlight">\(W\)</span> leads to jerky motion and poor convergence. Too small <span class="math notranslate nohighlight">\(W\)</span> leads to slow exploration.</p></li>
<li><p><strong>Hill Width (<span class="math notranslate nohighlight">\(\sigma\)</span>):</strong> Should be related to the fluctuations or roughness of the underlying free energy landscape along the CV. Often chosen to be a fraction of the width of the features (like wells) you want to resolve. Too large <span class="math notranslate nohighlight">\(\sigma\)</span> smooths out details; too small <span class="math notranslate nohighlight">\(\sigma\)</span> can create artificial minima.</p></li>
<li><p><strong>Deposition Stride (<span class="math notranslate nohighlight">\(	au\)</span>):</strong> Determines how frequently hills are added. Should be long enough for the system to diffuse slightly away from the last deposited hill, but short enough for efficient exploration.</p></li>
</ul>
<p>Finding optimal parameters often requires some trial and error.</p>
<p>The corresponding bias force at time <span class="math notranslate nohighlight">\(t\)</span> is the negative gradient of the <em>total</em> bias potential:
$<span class="math notranslate nohighlight">\( F_{bias}(x, t) = -\frac{\partial V_{bias}(x, t)}{\partial x} = \sum_{t' &lt; t} W \frac{(x - x(t'))}{\sigma^2} \exp\left(-\frac{(x - x(t'))^2}{2\sigma^2}\right) \)</span>$</p>
</section>
<section id="lesson-7-3-implementing-metadynamics">
<h2>Lesson 7.3: Implementing Metadynamics<a class="headerlink" href="#lesson-7-3-implementing-metadynamics" title="Link to this heading">#</a></h2>
<section id="defining-metadynamics-bias-functions">
<h3>Defining Metadynamics Bias Functions<a class="headerlink" href="#defining-metadynamics-bias-functions" title="Link to this heading">#</a></h3>
<p>We need functions to calculate the total bias potential and force from a list of deposited hills.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the value of a Gaussian function.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gaussian_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the force (-dV/dx) from a Gaussian potential.&quot;&quot;&quot;</span>
  <span class="c1"># d/dx [ H * exp(-(x-c)^2 / (2*s^2)) ] = H * exp(...) * [ -(2*(x-c)) / (2*s^2) ]</span>
  <span class="c1"># Force = -d/dx = H * exp(...) * (x-c) / s^2</span>
  <span class="k">return</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_metad_bias_potential</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hills</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the total Metadynamics bias potential at position x from a list of hills.&quot;&quot;&quot;</span>
  <span class="n">total_bias</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="c1"># hills is expected to be a list of tuples: [(center1, height1, sigma1), (center2, height2, sigma2), ...]</span>
  <span class="k">for</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">hills</span><span class="p">:</span>
      <span class="n">total_bias</span> <span class="o">+=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">total_bias</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_metad_bias_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hills</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Calculates the total Metadynamics bias force at position x from a list of hills.&quot;&quot;&quot;</span>
  <span class="n">total_force</span> <span class="o">=</span> <span class="mf">0.0</span>
  <span class="k">for</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">hills</span><span class="p">:</span>
      <span class="n">total_force</span> <span class="o">+=</span> <span class="n">gaussian_force</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">total_force</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadynamics bias functions defined.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Metadynamics bias functions defined.
</pre></div>
</div>
</div>
</div>
</section>
<section id="modifying-the-integrator-for-metadynamics-bias">
<h3>Modifying the Integrator for Metadynamics Bias<a class="headerlink" href="#modifying-the-integrator-for-metadynamics-bias" title="Link to this heading">#</a></h3>
<p>We adapt the Langevin integrator to accept the <em>current list</em> of deposited hills and use the <code class="docutils literal notranslate"><span class="pre">calculate_metad_bias_force</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">langevin_metad_step</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">target_temp</span><span class="p">,</span>
                              <span class="n">force_physical_func</span><span class="p">,</span> <span class="n">current_hills</span><span class="p">,</span>
                              <span class="n">physical_args</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs one step of Langevin dynamics using BAOAB with physical + MetaD bias forces.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_curr, v_curr, mass, dt, gamma, target_temp: Standard Langevin parameters.</span>
<span class="sd">        force_physical_func (callable): Function for the physical force (e.g., force_dw).</span>
<span class="sd">        current_hills (list): List of tuples [(center, height, sigma), ...] for deposited hills.</span>
<span class="sd">        physical_args (dict): Keyword arguments for the physical force function.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (x_new, v_new) - Updated position and velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Calculate total force F = F_physical + F_metad_bias</span>
    <span class="n">f_phys_curr</span> <span class="o">=</span> <span class="n">force_physical_func</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="o">**</span><span class="n">physical_args</span><span class="p">)</span>
    <span class="n">f_bias_curr</span> <span class="o">=</span> <span class="n">calculate_metad_bias_force</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">current_hills</span><span class="p">)</span> <span class="c1"># History-dependent bias</span>
    <span class="n">f_total_curr</span> <span class="o">=</span> <span class="n">f_phys_curr</span> <span class="o">+</span> <span class="n">f_bias_curr</span>

    <span class="c1"># Update velocity by half step</span>
    <span class="n">v_half_b</span> <span class="o">=</span> <span class="n">v_curr</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_total_curr</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="c1"># Update position by half step</span>
    <span class="n">x_half_a</span> <span class="o">=</span> <span class="n">x_curr</span> <span class="o">+</span> <span class="n">v_half_b</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="c1"># Apply friction and random kick (unchanged)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k_B</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_temp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">c1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span>
    <span class="n">random_kick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">v_half_o</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">v_half_b</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">random_kick</span>
    <span class="c1"># Update position by second half step</span>
    <span class="n">x_new</span> <span class="o">=</span> <span class="n">x_half_a</span> <span class="o">+</span> <span class="n">v_half_o</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Calculate total force at *new* position (using the *same* hill list for this step)</span>
    <span class="n">f_phys_new</span> <span class="o">=</span> <span class="n">force_physical_func</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="o">**</span><span class="n">physical_args</span><span class="p">)</span>
    <span class="n">f_bias_new</span> <span class="o">=</span> <span class="n">calculate_metad_bias_force</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">current_hills</span><span class="p">)</span> <span class="c1"># History-dependent bias</span>
    <span class="n">f_total_new</span> <span class="o">=</span> <span class="n">f_phys_new</span> <span class="o">+</span> <span class="n">f_bias_new</span>

    <span class="c1"># Update velocity by second half step</span>
    <span class="n">v_new</span> <span class="o">=</span> <span class="n">v_half_o</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_total_new</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_new</span><span class="p">,</span> <span class="n">v_new</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Langevin integrator adapted for Metadynamics.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Langevin integrator adapted for Metadynamics.
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-metadynamics-parameters">
<h3>Setting Metadynamics Parameters<a class="headerlink" href="#setting-metadynamics-parameters" title="Link to this heading">#</a></h3>
<p>Define the hill height <code class="docutils literal notranslate"><span class="pre">W</span></code>, width <code class="docutils literal notranslate"><span class="pre">sigma</span></code>, deposition stride <code class="docutils literal notranslate"><span class="pre">tau</span></code>, and simulation length.</p>
<section id="estimating-hill-width-from-unbiased-sampling">
<h4>7.2.1 Estimating Hill Width (σ) from Unbiased Sampling<a class="headerlink" href="#estimating-hill-width-from-unbiased-sampling" title="Link to this heading">#</a></h4>
<p>First, run a short unbiased MD (no metadynamics bias) to sample natural fluctuations of the CV. Then compute its standard deviation as the hill width.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unbiased MD to estimate sigma</span>
<span class="n">num_steps_unbiased</span> <span class="o">=</span> <span class="mi">3000</span> <span class="k">if</span> <span class="n">FAST_MODE</span> <span class="k">else</span> <span class="mi">10000</span>

<span class="c1"># Simulation parameters</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">target_temp_metad</span> <span class="o">=</span> <span class="n">barrier_height</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="c1"># 10% of the barrier height</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="n">target_temp_metad</span> <span class="c1"># Update global temperature</span>

<span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># start at center</span>
<span class="n">v</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">positions_unbiased</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">times_unbiased</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store time points for plotting</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_unbiased</span><span class="p">):</span>
    <span class="c1"># Simple Langevin without bias, reuse langevin_metad_step with zero bias</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">langevin_metad_step</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                               <span class="n">target_temp</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                               <span class="n">force_physical_func</span><span class="o">=</span><span class="n">force_dw</span><span class="p">,</span> <span class="n">current_hills</span><span class="o">=</span><span class="p">[],</span>
                               <span class="n">physical_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_dw</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_dw</span><span class="p">})</span>
    <span class="n">positions_unbiased</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">times_unbiased</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>  <span class="c1"># Record time</span>

<span class="c1"># Discard initial 10% for equilibration</span>
<span class="n">positions_unbiased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions_unbiased</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num_steps_unbiased</span><span class="o">/</span><span class="mi">10</span><span class="p">):])</span>
<span class="n">times_unbiased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times_unbiased</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num_steps_unbiased</span><span class="o">/</span><span class="mi">10</span><span class="p">):])</span>

<span class="c1"># Calculate and print standard deviation (sigma)</span>
<span class="n">sigma_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">positions_unbiased</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated hill width σ = </span><span class="si">{</span><span class="n">sigma_est</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot CV over time</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_unbiased</span><span class="p">,</span> <span class="n">positions_unbiased</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Collective Variable (x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Unbiased MD: CV over Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estimated hill width σ = 0.138
</pre></div>
</div>
<img alt="../../../_images/b2ba47486809c5a7252871816a70a31a935f9e8fb48edcfbe450e49bac76bcf9.png" src="../../../_images/b2ba47486809c5a7252871816a70a31a935f9e8fb48edcfbe450e49bac76bcf9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Metadynamics Parameters (using estimated σ and barrier/20)</span>
<span class="c1"># Hill width and height based on prior estimates</span>
<span class="n">metad_hill_sigma</span> <span class="o">=</span> <span class="n">sigma_est</span>  <span class="c1"># from unbiased sampling</span>
<span class="n">metad_hill_height</span> <span class="o">=</span> <span class="n">barrier_height</span> <span class="o">/</span> <span class="mi">50</span>  <span class="c1"># ~1/50 of barrier</span>
<span class="n">metad_deposition_stride</span> <span class="o">=</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">FAST_MODE</span> <span class="k">else</span> <span class="mi">100</span>  <span class="c1"># tau - steps between depositions</span>

<span class="c1"># Simulation parameters</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">target_temp_metad</span> <span class="o">=</span> <span class="n">temperature</span>  <span class="c1"># already set</span>
<span class="n">n_steps_metad</span> <span class="o">=</span> <span class="mi">30000</span> <span class="k">if</span> <span class="n">FAST_MODE</span> <span class="k">else</span> <span class="mi">200000</span>
<span class="n">record_stride_metad</span> <span class="o">=</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">FAST_MODE</span> <span class="k">else</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadynamics Parameters:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Hill width (σ): </span><span class="si">{</span><span class="n">metad_hill_sigma</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Hill height (W): </span><span class="si">{</span><span class="n">metad_hill_height</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Deposition stride: </span><span class="si">{</span><span class="n">metad_deposition_stride</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total steps: </span><span class="si">{</span><span class="n">n_steps_metad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Metadynamics Parameters:
  Hill width (σ): 0.138
  Hill height (W): 0.080
  Deposition stride: 100
  Total steps: 200000
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="setting-hill-width-and-height">
<h3>7.2.2 Setting Hill Width and Height<a class="headerlink" href="#setting-hill-width-and-height" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Hill width (σ)</strong> is set to the standard deviation estimated above: <code class="docutils literal notranslate"><span class="pre">σ</span> <span class="pre">=</span> <span class="pre">sigma_est</span></code>.</p></li>
<li><p><strong>Hill height (W)</strong> is set to <code class="docutils literal notranslate"><span class="pre">barrier_height</span> <span class="pre">/</span> <span class="pre">50</span></code>, i.e., 1/50 of the estimated barrier height.</p></li>
</ul>
</section>
<section id="coding-exercise-running-the-metadynamics-simulation">
<h3>Coding Exercise: Running the Metadynamics Simulation<a class="headerlink" href="#coding-exercise-running-the-metadynamics-simulation" title="Link to this heading">#</a></h3>
<p>Implement the Metadynamics simulation loop:</p>
<ol class="arabic simple">
<li><p>Initialize position, velocity, and an empty list <code class="docutils literal notranslate"><span class="pre">hills</span></code> to store Gaussian parameters.</p></li>
<li><p>Loop for <code class="docutils literal notranslate"><span class="pre">n_steps_metad</span></code>:</p>
<ul class="simple">
<li><p>Call the <code class="docutils literal notranslate"><span class="pre">langevin_baoab_metad_step</span></code> integrator, passing the <em>current</em> <code class="docutils literal notranslate"><span class="pre">hills</span></code> list.</p></li>
<li><p>Every <code class="docutils literal notranslate"><span class="pre">metad_deposition_stride</span></code> steps:</p>
<ul>
<li><p>Add the parameters (<code class="docutils literal notranslate"><span class="pre">x_curr</span></code>, <code class="docutils literal notranslate"><span class="pre">metad_hill_height</span></code>, <code class="docutils literal notranslate"><span class="pre">metad_hill_sigma</span></code>) of a new Gaussian hill centered at the <em>current</em> position to the <code class="docutils literal notranslate"><span class="pre">hills</span></code> list.</p></li>
</ul>
</li>
<li><p>Record position and current time periodically.</p></li>
<li><p>Optionally, record the height of the bias potential at the current position to monitor filling.</p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Run Metadynamics Simulation ---</span>

<span class="c1"># Data storage</span>
<span class="n">n_recorded_metad</span> <span class="o">=</span> <span class="n">n_steps_metad</span> <span class="o">//</span> <span class="n">record_stride_metad</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">times_metad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_recorded_metad</span><span class="p">)</span>
<span class="n">positions_metad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_recorded_metad</span><span class="p">)</span>
<span class="n">bias_potential_at_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_recorded_metad</span><span class="p">)</span> <span class="c1"># Track bias value at particle&#39;s position</span>
<span class="n">hills</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List to store deposited hills: [(center, height, sigma), ...]</span>
<span class="n">num_hills_deposited</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Track number of hills over time</span>

<span class="c1"># Initial conditions</span>
<span class="n">x_curr</span> <span class="o">=</span> <span class="o">-</span><span class="n">minima_pos</span> <span class="c1"># Start in the left well</span>
<span class="n">v_curr</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Store initial state</span>
<span class="n">record_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">positions_metad</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_curr</span>
<span class="n">bias_potential_at_x</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">times_metad</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">num_hills_deposited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Metadynamics simulation (</span><span class="si">{</span><span class="n">n_steps_metad</span><span class="si">}</span><span class="s2"> steps)...&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Main simulation loop</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps_metad</span><span class="p">):</span>
    <span class="c1"># Deposit hill if stride is reached</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">metad_deposition_stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hills</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">metad_hill_height</span><span class="p">,</span> <span class="n">metad_hill_sigma</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># Print progress periodically</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Deposited </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">)</span><span class="si">}</span><span class="s2"> hills...&quot;</span><span class="p">)</span>

    <span class="c1"># Perform one integration step using current hills list</span>
    <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span> <span class="o">=</span> <span class="n">langevin_metad_step</span><span class="p">(</span>
        <span class="n">x_curr</span><span class="p">,</span> <span class="n">v_curr</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">target_temp_metad</span><span class="p">,</span>
        <span class="n">force_dw</span><span class="p">,</span> <span class="n">hills</span><span class="p">,</span>
        <span class="n">physical_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_dw</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b_dw</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Record data</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">record_stride_metad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">record_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">record_idx</span> <span class="o">&lt;</span> <span class="n">n_recorded_metad</span><span class="p">:</span>
            <span class="n">times_metad</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">positions_metad</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_curr</span>
            <span class="c1"># Calculate current bias potential value at particle position (can be slow if many hills)</span>
            <span class="n">bias_potential_at_x</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_metad_bias_potential</span><span class="p">(</span><span class="n">x_curr</span><span class="p">,</span> <span class="n">hills</span><span class="p">)</span>
            <span class="n">num_hills_deposited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">))</span>


<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadynamics simulation finished. Time taken: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total hills deposited: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Trim recorded arrays if simulation ended before last recording step</span>
<span class="n">times_metad</span> <span class="o">=</span> <span class="n">times_metad</span><span class="p">[:</span><span class="n">record_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">positions_metad</span> <span class="o">=</span> <span class="n">positions_metad</span><span class="p">[:</span><span class="n">record_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="n">bias_potential_at_x</span> <span class="o">=</span> <span class="n">bias_potential_at_x</span><span class="p">[:</span><span class="n">record_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Ensure num_hills_deposited aligns with times_metad</span>
<span class="n">num_hills_deposited_timed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">times_metad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">num_hills_deposited</span><span class="p">))</span> <span class="o">*</span> <span class="n">metad_deposition_stride</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_hills_deposited</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting Metadynamics simulation (200000 steps)...
  Step 10000, Deposited 100 hills...
  Step 20000, Deposited 200 hills...
  Step 30000, Deposited 300 hills...
  Step 40000, Deposited 400 hills...
  Step 50000, Deposited 500 hills...
  Step 60000, Deposited 600 hills...
  Step 70000, Deposited 700 hills...
  Step 80000, Deposited 800 hills...
  Step 90000, Deposited 900 hills...
  Step 100000, Deposited 1000 hills...
  Step 110000, Deposited 1100 hills...
  Step 120000, Deposited 1200 hills...
  Step 130000, Deposited 1300 hills...
  Step 140000, Deposited 1400 hills...
  Step 150000, Deposited 1500 hills...
  Step 160000, Deposited 1600 hills...
  Step 170000, Deposited 1700 hills...
  Step 180000, Deposited 1800 hills...
  Step 190000, Deposited 1900 hills...
  Step 200000, Deposited 2000 hills...
Metadynamics simulation finished. Time taken: 901.39 seconds.
Total hills deposited: 2000
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="lesson-7-4-reconstructing-the-free-energy">
<h2>Lesson 7.4: Reconstructing the Free Energy<a class="headerlink" href="#lesson-7-4-reconstructing-the-free-energy" title="Link to this heading">#</a></h2>
<p>In Metadynamics, the simulation explores the landscape by progressively filling the wells with the bias potential <span class="math notranslate nohighlight">\(V_{bias}(x, t)\)</span>. As the simulation converges (i.e., the particle diffuses back and forth across the landscape relatively freely), the accumulated bias potential becomes an estimate of the negative of the underlying free energy (PMF), up to an irrelevant additive constant:</p>
<div class="math notranslate nohighlight">
\[ F(x) \approx -V_{bias}(x, t \to \infty) + C \]</div>
<p>Therefore, we can reconstruct the PMF simply by calculating the negative of the total bias potential from <em>all</em> the deposited hills at the end of the simulation.</p>
<p><strong>Monitoring Convergence:</strong>
How do we know if the simulation has run long enough (“converged”)?</p>
<ul class="simple">
<li><p><strong>Trajectory:</strong> Plot the position <span class="math notranslate nohighlight">\(x\)</span> vs. time. Has the particle crossed the main barrier(s) multiple times?</p></li>
<li><p><strong>Bias Potential Growth:</strong> Plot the height of the bias potential evaluated at the particle’s current position (<span class="math notranslate nohighlight">\(V_{bias}(x(t), t)\)</span>) vs. time. It should initially increase as wells are filled, then plateau or fluctuate around a relatively constant value once the main barriers are overcome.</p></li>
<li><p><strong>Collective Variable Diffusion:</strong> The particle should appear to diffuse relatively freely along the CV once the landscape is filled.</p></li>
<li><p><strong>PMF Stability:</strong> Calculate the PMF estimate (<span class="math notranslate nohighlight">\(-V_{bias}\)</span>) using hills deposited up to different times (e.g., half the simulation vs. the full simulation). If the PMF shape is stable, it suggests convergence.</p></li>
</ul>
<p>Let’s visualize the trajectory and the bias potential growth first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Visualize Metadynamics Trajectory and Convergence ---</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot position vs time</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_metad</span><span class="p">,</span> <span class="n">positions_metad</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Metadynamics Trajectory&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="n">minima_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minima&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">minima_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>


<span class="c1"># Plot bias potential at current position vs time</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_metad</span><span class="p">,</span> <span class="n">bias_potential_at_x</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$V_</span><span class="si">{bias}</span><span class="s1">(x(t), t)$&#39;</span><span class="p">)</span>
<span class="c1"># Add number of hills on secondary y-axis</span>
<span class="n">ax1b</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax1b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_metad</span><span class="p">,</span> <span class="n">num_hills_deposited_timed</span><span class="p">,</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Num. Hills&#39;</span><span class="p">)</span>
<span class="n">ax1b</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of Hills&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax1b</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Bias Potential at x(t) ($k_B T$ units)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Metadynamics Bias Growth &amp; Convergence&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax1b</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Check if the trajectory explores both wells and crosses the barrier.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Check if the bias potential growth starts to level off (indicating wells are being filled).&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/e39de08ee7ad49af8ceaa7d34e11cc28fb9394fcd0cd44328f5ac4dbd5b89e55.png" src="../../../_images/e39de08ee7ad49af8ceaa7d34e11cc28fb9394fcd0cd44328f5ac4dbd5b89e55.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Check if the trajectory explores both wells and crosses the barrier.
Check if the bias potential growth starts to level off (indicating wells are being filled).
</pre></div>
</div>
</div>
</div>
<section id="exercise-calculating-and-plotting-the-reconstructed-pmf">
<h3>Exercise: Calculating and Plotting the Reconstructed PMF<a class="headerlink" href="#exercise-calculating-and-plotting-the-reconstructed-pmf" title="Link to this heading">#</a></h3>
<p>Now, calculate the final total bias potential <span class="math notranslate nohighlight">\(V_{bias}(x, t_{final})\)</span> over a grid of <span class="math notranslate nohighlight">\(x\)</span> values using all the deposited <code class="docutils literal notranslate"><span class="pre">hills</span></code>. The reconstructed PMF is then <span class="math notranslate nohighlight">\(-V_{bias}(x, t_{final})\)</span>. Plot this against the analytical potential.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span> <span class="c1"># To handle potential log(0) issues</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span> <span class="c1"># To track simulation time</span>

<span class="c1"># --- Calculate and Plot Reconstructed PMF ---</span>

<span class="c1"># Define grid for calculating final PMF</span>
<span class="n">n_bins_pmf</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ensure positions_metad is not empty before calculating min/max</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions_metad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">pmf_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">positions_metad</span><span class="p">)</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">positions_metad</span><span class="p">)</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">n_bins_pmf</span><span class="p">)</span> <span class="c1"># Grid based on sampled range</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Provide a default grid if positions_metad is empty</span>
    <span class="n">pmf_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_bins_pmf</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: positions_metad is empty. Using default grid for PMF.&quot;</span><span class="p">)</span>


<span class="c1"># Calculate final bias potential on the grid using *all* deposited hills</span>
<span class="c1"># Ensure hills list is not empty</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">final_bias_potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_metad_bias_potential</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hills</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf_grid</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">final_bias_potential</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">)</span> <span class="c1"># Bias is zero if no hills deposited</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: hills list is empty. Final bias potential is zero.&quot;</span><span class="p">)</span>


<span class="c1"># Reconstructed PMF = - Final Bias Potential</span>
<span class="n">pmf_metad</span> <span class="o">=</span> <span class="o">-</span><span class="n">final_bias_potential</span>

<span class="c1"># Shift PMF so minimum is zero (only if pmf_metad is not all zeros)</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pmf_metad</span><span class="p">):</span>
    <span class="n">min_pmf_metad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pmf_metad</span><span class="p">)</span>
    <span class="n">pmf_metad</span> <span class="o">-=</span> <span class="n">min_pmf_metad</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">min_pmf_metad</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Keep minimum at zero if PMF is flat</span>

<span class="c1"># Calculate analytical potential on the same grid for comparison</span>
<span class="n">analytical_potential_metad</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>
<span class="n">analytical_potential_metad</span> <span class="o">-=</span> <span class="n">minima_val</span> <span class="c1"># Shift minimum to zero</span>


<span class="c1"># --- Plot Reconstructed PMF vs Analytical ---</span>
<span class="c1"># plt.figure(figsize=(10, 7))</span>

<span class="c1"># Plot analytical potential</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">analytical_potential_metad</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target PMF (Analytical Potential)&quot;</span><span class="p">)</span>

<span class="c1"># Plot Metadynamics PMF</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">pmf_metad</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PMF from Metadynamics&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Free Energy / Potential (shifted, $k_B T$ units)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PMF from Metadynamics vs Analytical Potential&quot;</span><span class="p">)</span>
<span class="c1"># Use calculated barrier_height if available, otherwise use a default</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">plot_ylim_upper</span> <span class="o">=</span> <span class="n">barrier_height</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">barrier_height</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">5</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">plot_ylim_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">analytical_potential_metad</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Default based on analytical potential</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot_ylim_upper</span><span class="p">)</span> <span class="c1"># Adjust ylim</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Calculate and print barrier height only if pmf_metad is not flat zero</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pmf_metad</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PMF Barrier Height (Metadynamics, approx): </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pmf_metad</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PMF from Metadynamics is flat (likely no hills deposited or converged bias is zero).&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compare the green line (PMF from MetaD) to the red dashed line (analytical).&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy depends on simulation length and MetaD parameters.&quot;</span><span class="p">)</span>


<span class="c1"># --- Visualize Overall Potential Landscape ---</span>
<span class="c1"># This part uses variables calculated above in this same cell.</span>

<span class="c1"># Calculate the overall potential (shifted analytical + final bias)</span>
<span class="n">overall_potential</span> <span class="o">=</span> <span class="n">analytical_potential_metad</span> <span class="o">+</span> <span class="n">final_bias_potential</span>

<span class="c1"># Plot the shifted analytical potential (underlying FE)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">analytical_potential_metad</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Underlying Potential (Shifted)&quot;</span><span class="p">)</span>

<span class="c1"># Plot the final accumulated bias potential</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">final_bias_potential</span><span class="p">,</span> <span class="s1">&#39;b:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Final Bias Potential ($V_</span><span class="si">{bias}</span><span class="s2">$)&quot;</span><span class="p">)</span>

<span class="c1"># Plot the overall potential felt by the particle at the end</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">overall_potential</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Overall Potential ($V_</span><span class="si">{analytical}</span><span class="s2"> + V_</span><span class="si">{bias}</span><span class="s2">$)&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Position (x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Energy ($k_B T$ units)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Potential Landscape After Metadynamics Simulation&quot;</span><span class="p">)</span>
<span class="c1"># Adjust ylim for better visualization, considering the bias potential height</span>
<span class="n">plot_ylim_lower_overall</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">analytical_potential_metad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">overall_potential</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">plot_ylim_upper_overall</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">final_bias_potential</span><span class="p">)</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">overall_potential</span><span class="p">)</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">plot_ylim_lower_overall</span><span class="p">,</span> <span class="n">plot_ylim_upper_overall</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The black line shows the &#39;flattened&#39; landscape the particle sees at the end.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The bias potential (blue dotted) effectively cancels the underlying potential wells (red dashed).&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3f87b3ccbf87a67151a9132a7d9b0ee682105769ec3f732281d939cee6032eeb.png" src="../../../_images/3f87b3ccbf87a67151a9132a7d9b0ee682105769ec3f732281d939cee6032eeb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PMF Barrier Height (Metadynamics, approx): 14.48
Compare the green line (PMF from MetaD) to the red dashed line (analytical).
Accuracy depends on simulation length and MetaD parameters.
</pre></div>
</div>
<img alt="../../../_images/44f46fb9c837d0c2e6415ae5c48202dbf51cf3f0a73d33ead563f5e29572dcbc.png" src="../../../_images/44f46fb9c837d0c2e6415ae5c48202dbf51cf3f0a73d33ead563f5e29572dcbc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The black line shows the &#39;flattened&#39; landscape the particle sees at the end.
The bias potential (blue dotted) effectively cancels the underlying potential wells (red dashed).
</pre></div>
</div>
</div>
</div>
</section>
<section id="convergence-of-pmf-vs-number-of-hills">
<h3>7.4.2 Convergence of PMF vs. Number of Hills<a class="headerlink" href="#convergence-of-pmf-vs-number-of-hills" title="Link to this heading">#</a></h3>
<p>After reconstructing the PMF from all deposited hills, assess convergence by rebuilding the PMF using only the first (m) hills (for (m = 50, 100, \dots)):</p>
<ul class="simple">
<li><p>Compute the PMF on the same grid for subsets of hills.</p></li>
<li><p>Track:</p>
<ul>
<li><p>ΔG between the two minima</p></li>
<li><p>Barrier height between minima</p></li>
</ul>
</li>
</ul>
<p>Plot these as a function of the number of hills to ensure the PMF has stabilized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># --- Reconstruct full PMF from all hills (for reference) ---</span>
<span class="c1"># # Define grid based on sampled CV range</span>
<span class="c1"># n_bins_pmf = 100</span>

<span class="c1"># Compute underlying (analytical) potential on that grid</span>
<span class="n">underlying</span> <span class="o">=</span> <span class="n">potential_dw</span><span class="p">(</span><span class="n">pmf_grid</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a_dw</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b_dw</span><span class="p">)</span>

<span class="c1"># --- Convergence analysis: PMF vs. Number of Hills in steps of 200 ---</span>

<span class="c1"># Known CV positions of the two minima and the barrier</span>
<span class="n">min1_pos</span><span class="p">,</span> <span class="n">min2_pos</span><span class="p">,</span> <span class="n">barrier_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.41</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.41</span><span class="p">,</span> <span class="mf">0.00</span>

<span class="c1"># Map those to the closest grid indices</span>
<span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pmf_grid</span> <span class="o">-</span> <span class="n">min1_pos</span><span class="p">))</span>
<span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pmf_grid</span> <span class="o">-</span> <span class="n">min2_pos</span><span class="p">))</span>
<span class="n">idxb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pmf_grid</span> <span class="o">-</span> <span class="n">barrier_pos</span><span class="p">))</span>

<span class="c1"># Prepare hill‐count steps</span>
<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">total_hills</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hills</span><span class="p">)</span>
<span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">total_hills</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>

<span class="c1"># Storage for free‐energy metrics</span>
<span class="n">dg_minima</span>   <span class="o">=</span> <span class="p">[]</span>
<span class="n">barrier_h1</span>  <span class="o">=</span> <span class="p">[]</span>
<span class="n">barrier_h2</span>  <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop over subsets of the first m hills</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
    <span class="c1"># Build bias from hills 0 … m-1</span>
    <span class="n">bias_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_metad_bias_potential</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hills</span><span class="p">[:</span><span class="n">m</span><span class="p">])</span>
                       <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pmf_grid</span><span class="p">])</span>
    <span class="c1"># Reconstruct subset‐PMF and shift min to zero</span>
    <span class="n">pmf_m</span> <span class="o">=</span> <span class="o">-</span> <span class="n">bias_m</span>
    <span class="n">pmf_m</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pmf_m</span><span class="p">)</span>

    <span class="c1"># ΔG between minima</span>
    <span class="n">dg_minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pmf_m</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmf_m</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span>
    <span class="c1"># Barrier heights measured from each minimum</span>
    <span class="n">barrier_h1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pmf_m</span><span class="p">[</span><span class="n">idxb</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmf_m</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span>
    <span class="n">barrier_h2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pmf_m</span><span class="p">[</span><span class="n">idxb</span><span class="p">]</span> <span class="o">-</span> <span class="n">pmf_m</span><span class="p">[</span><span class="n">idx2</span><span class="p">])</span>

<span class="c1"># Plot the convergence curves</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">dg_minima</span><span class="p">,</span>  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ΔG between minima&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">barrier_h1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Barrier from Min1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">barrier_h2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Barrier from Min2&#39;</span><span class="p">)</span>

<span class="c1"># Add lines for actual delta G and barrier height</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual ΔG (0)&#39;</span><span class="p">)</span>  <span class="c1"># delta G</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Barrier Height (4)&#39;</span><span class="p">)</span>  <span class="c1"># barrier height</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of hills included&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Free energy ($k_B T$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MetaD PMF Convergence vs. Number of Hills&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/12f9356ad95917065bb14feb369e09a535a263e2cad22b274df5febcce15d654.png" src="../../../_images/12f9356ad95917065bb14feb369e09a535a263e2cad22b274df5febcce15d654.png" />
</div>
</div>
</section>
</section>
<section id="lesson-7-5-comparing-us-and-metad">
<h2>Lesson 7.5: Comparing US and MetaD<a class="headerlink" href="#lesson-7-5-comparing-us-and-metad" title="Link to this heading">#</a></h2>
<p><strong>Umbrella Sampling (US)</strong></p>
<ul class="simple">
<li><p>Windows can be run <strong>in parallel</strong>—each umbrella simulation is independent.</p></li>
<li><p>Fast &amp; robust convergence for 1D collective variables.</p></li>
<li><p>For multiple CVs, the grid grows exponentially (e.g., 10×10 = 100 windows for 2D), which becomes computationally expensive.</p></li>
<li><p>Requires <strong>prior knowledge</strong> of which regions to sample to place umbrellas effectively.</p></li>
</ul>
<p><strong>Metadynamics (MetaD)</strong></p>
<ul class="simple">
<li><p>Runs <strong>a single long</strong> simulation, adaptively filling unknown regions of the free-energy landscape.</p></li>
<li><p>No need to predefine all minima/barriers—exploration is driven by the history-dependent bias.</p></li>
<li><p>Scales better to 2D+ CV spaces—avoids the combinatorial explosion of umbrellas.</p></li>
<li><p>May require longer wall-clock time to accumulate sufficient bias for convergence.</p></li>
</ul>
<hr class="docutils" />
<p>End of Module 7. We have explored and implemented Metadynamics:</p>
<ul class="simple">
<li><p><strong>Metadynamics Concept:</strong> Understood how adding history-dependent Gaussian hills fills free energy wells and facilitates barrier crossing.</p></li>
<li><p><strong>Implementation:</strong> Modified the Langevin integrator and simulation loop to incorporate the time-dependent MetaD bias.</p></li>
<li><p><strong>PMF Reconstruction:</strong> Learned that the converged MetaD bias potential provides an estimate of the negative free energy (<span class="math notranslate nohighlight">\(F(x) \approx -V_{bias}\)</span>).</p></li>
<li><p><strong>Visualization &amp; Comparison:</strong> Ran a MetaD simulation, monitored its progress, reconstructed the PMF, and compared it to the analytical potential and discussed its pros/cons relative to Umbrella Sampling.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "YOUR_USERNAME/YOUR_REPO",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_build/jupyter_execute/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-imports-and-functions-from-modules-4-5">Setup: Imports and Functions (from Modules 4 &amp; 5)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-1-the-concept-of-filling-the-free-energy-landscape">Lesson 7.1: The Concept of Filling the Free Energy Landscape</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-2-the-metadynamics-bias">Lesson 7.2: The Metadynamics Bias</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-3-implementing-metadynamics">Lesson 7.3: Implementing Metadynamics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-metadynamics-bias-functions">Defining Metadynamics Bias Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-the-integrator-for-metadynamics-bias">Modifying the Integrator for Metadynamics Bias</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-metadynamics-parameters">Setting Metadynamics Parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-hill-width-from-unbiased-sampling">7.2.1 Estimating Hill Width (σ) from Unbiased Sampling</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-hill-width-and-height">7.2.2 Setting Hill Width and Height</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-exercise-running-the-metadynamics-simulation">Coding Exercise: Running the Metadynamics Simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-4-reconstructing-the-free-energy">Lesson 7.4: Reconstructing the Free Energy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-calculating-and-plotting-the-reconstructed-pmf">Exercise: Calculating and Plotting the Reconstructed PMF</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-of-pmf-vs-number-of-hills">7.4.2 Convergence of PMF vs. Number of Hills</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lesson-7-5-comparing-us-and-metad">Lesson 7.5: Comparing US and MetaD</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Your Name
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>